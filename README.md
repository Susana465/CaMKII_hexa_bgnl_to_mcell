# Table of Contents

1. [What is in this repository](#what-is-in-this-repository)
    - [BioNetGen and MCell model files](#bionetgen-and-mcell-model-files)
    - [Run-the-model files](#run-the-model-files)
    - [Output files](#output-files)
    - [Parameter Sensitivity Analysis files](#parameter-sensitivity-analysis-files)
2. [Initial Setup Requirements](#initial-setup-requirements)
    - [Install MCell/CellBlender v4.0.6 bundle with Blender 2.93](#1-install-mcellcellblender-v406-bundle-with-blender-293)
    - [Setting System Variable MCELL_PATH and adding Python 3.9 to PATH](#2-setting-system-variable-mcell_path-and-adding-python-39-to-path)
    - [Set up a python environment](#3-set-up-a-python-environment)
3. [Running the code](#running-the-code)
    - [Step 1](#step-1)
    - [Step 2](#step-2)
    - [Step 3](#step-3)
    - [Step 4](#step-4)
    - [Expected Outputs](#expected-outputs)

# What is in this repository
---
This is the repository where a model for CaMKII and NMDAR interactions inside a postsynaptic dendrite are tested. 

There might be some files that are saved as tests outside of the main ones, as I try out different things.

The important files to run the simulation are:

## BioNetGen and MCell model files:
- [`mcell_params.py`](mcell_params.py): is the script where the PATH to mcell is defined, where the mcell model is set up, and where parameters are loaded.
- [`dodecamer.bngl`](dodecamer.bngl): where the model reactions are created and described using BNGL. 

## Run-the-model files:
- [`run_model.py`](run_model.py): script that runs the model.
- [`prepare_run_files.py`](prepare_run_files.py): script that prepares files to be copied, ran, and saved in a timestamped folder.

## Output files
- `data_output/`: contains timestamped folders that are created with scripts mentioned above. Each timestamped folder contains the outputs from running the python scripts, which should include a record of the parameters used (in a .csv file), the mcell_params.py file used, and the .bngl file used for that specific run.
- [`extracted_statsparams.csv`](extracted_statsparams.csv): this file is created during a sensitivity analysis run to store the required parameters and statistics. 

## Parameter Sensitivity Analysis files:
In order to perform sensitivity analysis on the parameters used for this model, the files requires are:
- [`global_sensitivity_run.py`](global_sensitivity_run.py): runs the model iteratively overriding specified parameters (for example, 'kon' or 'koff').
- [`sensitivity_store_analysis.py`](sensitivity_store_analysis.py): extracts required statistics from output data and stores it in a specified [`extracted_statsparams.csv`](extracted_statsparams.csv) file. This script also plots the stat vs parameter in a scatter plot.

# Initial Setup Requirements
---
In order to run the files in this repo, you will need a few requirements first:

## 1. Install  MCell/CellBlender v4.0.6 bundle with Blender 2.93
The CellBlender bundle containing MCell4 is available for download for different operating systems at the MCell.org website: https://mcell.org/download.html

As of 20230428 I used MCell/CellBlender v4.0.6 bundle with Blender 2.93, on Windows 10 to run this code.

As of 20230501 MCell MacOS Download isn't compatible with "Apple Silicone" devices; it looks like MCell is incompatible with the latest Mac hardware, which uses Arm chips.

I use VS Code as my IDE (Integrated development environment), but you can use whichever IDE you prefer. 

-  To save time and computational power, I run MCell4 outside of Blender.

-  To use MCell4 outside of Blender with Python 3.9, additional installation steps are required as described below:

## 2. Setting System Variable MCELL_PATH and adding Python 3.9 to PATH

### 2.1. Depending on your OS:
- In order to set the System Variable MCELL_PATH, depeding on your Operating System, please follow the instructions here: https://mcell.org/mcell4_documentation/installation.html#setting-system-variables

### 2.2. Why do you need to do this:

As per the mcell documentation, MCell4 Python models use the system variable MCELL_PATH to locate the MCell4 library. It is also useful as a shortcut to the location of utility scripts contained in the CellBlender bundle.

MCell4 also requires Python 3.9. You can either use you own installation or set the system variable PATH so that the Python included in the CellBlender bundle is found.

The models generated by CellBlender expect a system variable MCELL_PATH to be defined and use it to add this path (appended with ‘lib’) to the Python’s search paths like this: 

This is specified in the python files that need to access mcell when running.

```python
MCELL_PATH = os.environ.get('MCELL_PATH', '')
sys.path.append(os.path.join(MCELL_PATH, 'lib'))

import mcell as m
```

## 3. Set up an environment

In order to make sure we are both working with the same versions of python and dependencies required to run the python script in this repo, it will be useful to create an environment.

With a virtual environment, it’s possible to retain all the information in our projects like the dependencies, so anyone else can duplicate the same environment we’re working with.

### 3.1. If you have conda (the environment management system I use): 

You can use the [environment.yml](./environment.yml) file in this repo, and create an environment with the following command:

```
conda env create --file environment.yml
```

This will create an environment called *'camkii-project-env'*. Then activate the environment and run the [mcell_hexamer.py](./mcell_hexamer.py) file there.

PS. I have found [these carpentries](https://carpentries-incubator.github.io/introduction-to-conda-for-data-scientists/) quite helpful with queries regarding conda environments, if you need some guidance here. 

### 3.2. If you use a different environment manager:

You will likely need to use the [requirements.txt](./requirements.txt) file instead. 

The commands to create and activate an environment using virtualenv, pipenv, venv, pyenv, etc will be different depending on which one you use. As an example, if you were using [venv](https://docs.python.org/3/library/venv.html), then you would need to do something like this:

```virtualenv my-env ``` to create your new environment (called 'my-env' here)

```source my-env/bin/activate``` to enter the virtual environment

```pip install -r requirements.txt``` to install the requirements in the current environment

## 4. Running the code

Once you are set up with the above requirements, you can run the python script [`run_python_files.py`](run_python_files.py) in your terminal. This will run one iteration of the model.

```python
python run_python_files.py
```
### 4.3. Running the code iteratively

In order to run the model iteratively, with changing parameters, I used [`global_sensitivity_run.py`](global_sensitivity_run.py). This file can be run in the terminal command line:

```python
python global_sensitivity_run.py
```

### 4.2. Behind the scenes, what different files are used for:

The important files to run the simulation are:

#### Parameter files:
- [`mcell_params.py`](mcell_params.py): where variable mcell parameters are stored, and can be changed.
- [`dodecamer.bngl`](dodecamer.bngl): where model is created and described using BNGL. 

#### Run-the-model files:
- [`prepare_run_files.py`](prepare_run_files.py): script that prepares files to be copied, ran, and saved in a timestamped folder.
- [`run_python_files.py`](run_python_files.py): script executor that automates the execution of the other Python scripts.

## 5. Expected output

### Output files

- `data_output/`: contains timestamped folders that are created with scripts mentioned above. Each timestamped folder contains the outputs from running the python scripts.

/dated_directory_seed_number
├ dated_out.gdat

├dated_parameters.csv

├ dodecamer_NMDAR.bngl

├ mcell_params.py

### Visual Summary
![Visual Summary](visual_summary.PNG)

### Terminal Output
It takes about 10min to run in my machine.

(specs: Processor 11th Gen Intel(R) Core(TM) i5-1145G7 @ 2.60GHz   1.50 GHz, System type 64-bit operating system, x64-based processor, 16GB RAM)

The output in the terminal should look something like this:

```
$ python mcell_hexamer.py 
Import of MCell was sucessful
Initializing 27000 waypoints... 
Partition contains 30^3 subpartitions, subpartition size is 0.05 microns.
Copyright (C) 2006-2021 by
  The National Center for Multiscale Modeling of Biological Systems,
  The Salk Institute for Biological Studies, and
  Pittsburgh Supercomputing Center, Carnegie Mellon University,

**********************************************************************
MCell development is supported by the NIGMS-funded (P41GM103712)
National Center for Multiscale Modeling of Biological Systems (MMBioS).
Please acknowledge MCell in your publications.
**********************************************************************

Generated file data_layout.json for plotting in CellBlender.
Iterations: 0 of 3000
Released 10000 Ca@CP from "Release of Ca@CP at CP" at iteration 0.
Released 2000 CaM(ca~0,camkii)@CP from "Release of CaM(ca~0,camkii)@CP at CP" at iteration 0.
Released 2000 @CP:CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!1,r!2,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!3,r!1,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!4,r!3,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!5,r!4,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!6,r!5,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!2,r!6,c) from "Release of @CP:CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!6,r!1,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!1,r!2,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!2,r!3,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!3,r!4,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!4,r!5,c).CaMKII(active~0,T286~0,S306~0,cam,nmdar,l!5,r!6,c) at CP" at iteration 0.
Released 0 PP1@CP from "Release of PP1@CP at CP" at iteration 0.
Released 400 NMDAR(camkii)@PM from "Release of NMDAR(camkii)@PM at PM" at iteration 0.
Iterations: 100 of 3000 (3.46508 iter/sec) [active/total species 19/25, rxn classes 25, active/total reactant classes 8/8]
Iterations: 200 of 3000 (3.62197 iter/sec) [active/total species 19/25, rxn classes 25, active/total reactant classes 8/8]
[...]  
Iterations: 3000 of 3000 (5.47416 iter/sec) [active/total species 36/60, rxn classes 58, active/total reactant classes 8/8]     
Iteration 3000, simulation finished successfully
Total number of ray-subvolume intersection tests (number of ray_trace calls): 185680768
Total number of ray-polygon intersection tests: 752512295
Total number of ray-polygon intersections: 28199573
Total number of mol reflections from a wall: 13771810
Total number of vol mol vol mol collisions: 2835464
Total number of molecule moves between walls: 160272
Total number of usages of waypoints for counted volumes: 0
Total number of counted volume recomputations: 143638840
Total number of diffuse 3d calls: 171908958
Average diffusion jump was: 0.170364 timesteps  (2.94916e+07/173108958)
Simulation CPU time = 742 (user) and 3.5 (system)
Simulation CPU time without iteration 0 = 741.672 (user) and 3.45312 (system)
```
Running this code will create a timestamped [out.gdat](./out.gdat) file in the data_output/ folder. You should get an output that looks similar to this:

![alt text](./out_gdat.png)

Image: [out_gdat.png](./out_gdat.png)

Note: This output is obtained from running the model with:

ITERATIONS = 3e3 (defined in [hexamer_20220624.bngl](./hexamer_20220624.bngl#L15))

model.config.time_step = 1e-4 (defined in [mcell_hexamer.py](./mcell_hexamer.py#L52))

## References

Ordyan, Mariam, et al. "Interactions between calmodulin and neurogranin govern the dynamics of CaMKII as a leaky integrator." PLoS computational biology 16.7 (2020): e1008015.
https://doi.org/10.1371/journal.pcbi.1008015
